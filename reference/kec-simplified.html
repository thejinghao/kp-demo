<!DOCTYPE html>
<html lang="en">

<head>
  <title>Klarna Express Checkout</title>

  <script>
    window.klarnaAsyncCallback = function() {
      window.onload = function() {
        var radios = document.getElementsByName('auto_finalize');
        // get the default selected value
        var defaultSelected = document.querySelector('input[name="auto_finalize"]:checked').value;
        console.log("auto_finalize: ", defaultSelected);
        for (var i = 0, length = radios.length; i < length; i++) {
          radios[i].onclick = function() {
            var autoFinalizeValue = this.value;
            console.log("auto_finalize: ", autoFinalizeValue); // print the value to the console
          }
        }
      }
      window.Klarna.Payments.Buttons.init({
        client_key: "klarna_test_client_ZHh4PzVrciRtZWtQTzdSR2RXY0wyYnhQbHBuUjk1OCMsMjllYjEwZGYtOGE5OC00OGFmLWIwMjQtMGViMzFmNjhlNGQwLDEseDNIcWhEdlpZSmNOMXcrTVFPL1p1cXFod2djZEdrUTQ1N055UytJMHhkUT0",
      }).load({
          container: "#container",
          theme: "dark",
          shape: "pill",
          locale: "en-US",
          on_click: (authorize) => {
            var order_payload = {
              "purchase_country": "US",
              "purchase_currency": "USD",
              "intent": "buy_and_default_tokenize",
              "locale": "en-US",
              "merchant_reference1": "12142424",
              "merchant_reference2": "phe2323",
              "merchant_urls": {
                "authorization": "https://webhook.site/c292a862-2376-4944-aea7-25fcba1ebe7d",
                "confirmation": "https://example.com/confirmation"
              },
              "order_amount": 19092,
              "order_lines": [{
                  "product_url": "https://example.com/product",
                  "image_url": "https://example.com/image.jpg",
                  "type": "physical",
                  "reference": "PROD-001",
                  "name": "Sample Product",
                  "quantity": 1,
                  "unit_price": 19092,
                  "total_amount": 19092
                }
              ]
            };
            
            // Display authorize payload
            document.getElementById('authorize-payload').textContent = JSON.stringify(order_payload, null, 2);
            var autoFinalizeValue = document.querySelector('input[name="auto_finalize"]:checked').value;
            console.log("autoFinalizeValue: ", autoFinalizeValue); // print the value to the console
            authorize({
                collect_shipping_address: false,
                auto_finalize: autoFinalizeValue === "true"
              },
              order_payload,
              (result) => {
                document.getElementById('authorize-results').style.display = 'table';
                document.getElementById('client_token').textContent = result.client_token
                document.getElementById('authorization_token').textContent = result.authorization_token
                document.getElementById('approved').textContent = result.approved
                document.getElementById('collected_shipping_address').textContent = JSON.stringify(result.collected_shipping_address)
                document.getElementById('finalize_required').textContent = result.finalize_required
                console.log('authorize result', result),
                  console.log('authorize client_token:', result.client_token),
                  console.log('authorize authorization_token:', result.authorization_token),
                  console.log('authorize approved:', result.approved),
                  console.log('authorize collected_shipping_address:', result.collected_shipping_address),
                  console.log('authorize: finalize_required:', result.finalize_required)
                var isApproved = result.approved;
                var authorizationTokenNotEmpty = (result.authorization_token !== "");
                var isFinalizedRequired = result.finalize_required
                if (isApproved && authorizationTokenNotEmpty && !isFinalizedRequired) {
                  // create success message
                  var message = document.createElement('p');
                  message.textContent = 'Authorization Finalized!';
                  message.style.color = 'green';
                  message.style.fontSize = '1.2rem';
                  message.style.fontWeight = 'bold';
                  // Select the messageContainer and append the success message
                  var messageContainer = document.getElementById('message-container');
                  messageContainer.appendChild(message);
                }
                if (result.finalize_required) {
                  var btnContainer = document.querySelector('.mt-5');
                  var finalizeBtn = document.createElement('button');
                  btnContainer.style.marginTop = '10px';
                  finalizeBtn.textContent = 'Place Order // finalize()';
                  finalizeBtn.style.backgroundColor = 'black';
                  finalizeBtn.style.color = 'white';
                  finalizeBtn.style.width = '325px'; // button width
                  finalizeBtn.style.height = '50px'; // button height
                  finalizeBtn.style.marginBottom = '20px';
                  finalizeBtn.style.border = 'none'; // removes the border
                  finalizeBtn.style.boxShadow = '5px 5px 10px rgba(0, 0, 0, .25)';
                  finalizeBtn.style.borderRadius = '25px';
                  finalizeBtn.style.fontWeight = 'bold';
                  document.querySelector('.payloadOptions').style.display = 'block';
                  finalizeBtn.onclick = function() {
                    var selectedOption = document.querySelector('input[name="payload_option"]:checked').value;
                    var payload1 = {
                      "purchase_country": "US",
                      "purchase_currency": "USD",
                      "locale": "en-US",
                      "merchant_reference1": "12142424",
                      "merchant_reference2": "phe2323",
                      "merchant_urls": {
                        "authorization": "https://webhook.site/c292a862-2376-4944-aea7-25fcba1ebe7d"
                      },
                      "order_amount": 19092,
                      "order_lines": [{
                          "product_url": "https://example.com/product",
                          "image_url": "https://example.com/image.jpg",
                          "type": "physical",
                          "reference": "PROD-001",
                          "name": "Sample Product",
                          "quantity": 1,
                          "unit_price": 19092,
                          "total_amount": 19092
                        }
                      ]
                    };
                    var payload2 = {
                      "purchase_country": "US",
                      "purchase_currency": "USD",
                      "locale": "en-US",
                      "merchant_reference1": "12142424",
                      "merchant_reference2": "phe2323",
                      "merchant_urls": {
                        "authorization": "https://webhook.site/c292a862-2376-4944-aea7-25fcba1ebe7d"
                      },
                      "order_amount": 20000,
                      "order_lines": [{
                          "product_url": "https://example.com/product",
                          "image_url": "https://example.com/image.jpg",
                          "type": "physical",
                          "reference": "PROD-001",
                          "name": "Sample Product",
                          "quantity": 1,
                          "unit_price": 20000,
                          "total_amount": 20000
                        }
                      ]
                    };
                    var payload3 = {
                      "purchase_country": "US",
                      "purchase_currency": "USD",
                      "locale": "en-US",
                      "merchant_reference1": "12142424",
                      "merchant_reference2": "phe2323",
                      "merchant_urls": {
                        "authorization": "https://webhook.site/c292a862-2376-4944-aea7-25fcba1ebe7d"
                      },
                      "order_amount": function() {
                        var customAmount = document.getElementById('custom-amount').value;
                        return parseInt(customAmount) * 100; // Convert dollars to cents
                      },
                      "order_lines": [{
                          "product_url": "https://example.com/product",
                          "image_url": "https://example.com/image.jpg",
                          "type": "physical",
                          "reference": "PROD-001",
                          "name": "Sample Product",
                          "quantity": 1,
                          "unit_price": function() {
                            var customAmount = document.getElementById('custom-amount').value;
                            return parseInt(customAmount) * 100; // Convert dollars to cents
                          },
                          "total_amount": function() {
                            var customAmount = document.getElementById('custom-amount').value;
                            return parseInt(customAmount) * 100; // Convert dollars to cents
                          }
                        }
                      ]
                    };
                    var payload6 = {
                      "purchase_country": "CA",
                      "purchase_currency": "CAD",
                      "locale": "es-CA",
                      "merchant_reference1": "12142424",
                      "merchant_reference2": "phe2323",
                      "merchant_urls": {
                        "authorization": "https://webhook.site/c292a862-2376-4944-aea7-25fcba1ebe7d"
                      },
                      "order_amount": 19092,
                      "order_lines": [{
                          "product_url": "https://example.com/product",
                          "image_url": "https://example.com/image.jpg",
                          "type": "physical",
                          "reference": "PROD-001",
                          "name": "Sample Product",
                          "quantity": 1,
                          "unit_price": 19092,
                          "total_amount": 19092
                        }
                      ]
                    };
                    var payloads = {
                      'option1': payload1,
                      'option2': payload2,
                      'option3': payload3,
                      'option6': payload6,
                    }
                    var selectedPayload = payloads[selectedOption];
                    
                    // Handle custom amount payload
                    if (selectedOption === 'option3') {
                      var customAmount = document.getElementById('custom-amount').value;
                      if (!customAmount || isNaN(customAmount)) {
                        alert('Please enter a valid custom amount');
                        return;
                      }
                      var amountInCents = parseInt(customAmount) * 100;
                      selectedPayload.order_amount = amountInCents;
                      selectedPayload.order_lines[0].unit_price = amountInCents;
                      selectedPayload.order_lines[0].total_amount = amountInCents;
                    }
                    
                    // Display finalize payload
                    document.getElementById('finalize-payload').textContent = JSON.stringify(selectedPayload, null, 2);
                    document.getElementById('finalize-payload-display').style.display = 'block';
                    
                    Klarna.Payments.finalize({}, selectedPayload, function(res) {
                      console.log('res', res)
                      document.getElementById('client_token').textContent = res.client_token
                      document.getElementById('authorization_token').textContent = res.authorization_token
                      document.getElementById('approved').textContent = res.approved
                      document.getElementById('collected_shipping_address').textContent = JSON.stringify(res.collected_shipping_address)
                      document.getElementById('finalize_required').textContent = res.finalize_required
                      var authorizationTokenNotEmpty = (res.authorization_token !== "");
                      if (res.approved && !res.finalize_required && authorizationTokenNotEmpty) {
                        finalizeBtn.style.display = 'none'; // hide the button
                        document.querySelector('.payloadOptions').style.display = 'none'; // hide payload options
                        // Creating a success message 
                        var message = document.createElement('p');
                        message.textContent = 'Authorization Finalized!';
                        message.style.color = 'green';
                        message.style.fontSize = '1.2rem';
                        message.style.fontWeight = 'bold';
                        // append the success message to the finalize button's parent
                        finalizeBtn.parentNode.insertBefore(message, finalizeBtn.nextSibling);
                      }
                    });
                  };
                  btnContainer.insertBefore(finalizeBtn, document.getElementById('authorize-results'));
                }
              },
            );
          },
        },
        function load_callback(loadResult) {
          console.log('loadResult', loadResult),
            console.log('loadResult show_form:', loadResult.show_form),
            console.log('loadResult error:', loadResult.error)
        },
      );
    };
    Klarna.Payments.init({
      client_token: result.client_token
    });
  </script>

  <script src="https://x.klarnacdn.net/kp/lib/v1/api.js" async></script>
</head>

<body>

  <div class="container" style="display: flex; gap: 20px; padding: 20px;">

    <div class="left-column" style="flex: 1;">
      <h1 style="margin-top: 16px;"> Klarna Express Checkout (KEC) Demo</h1>
      
      <div class="summary">
        <h2>Configuration</h2>
        <div class="auto-finalize">
          <div class="auto-finalize-options">
            <h3>auto_finalize:</h3>
            <input type="radio" id="auto_finalize_true" name="auto_finalize" value="true" checked>
            <label for="auto_finalize_true">True</label>
            <input type="radio" id="auto_finalize_false" name="auto_finalize" value="false">
            <label for="auto_finalize_false">False</label>
          </div>
        </div>
        <div id="container"></div>
      </div>

      <div id="message-container"></div>
      
      <div class="payloadOptions" style="display: none;">
        <h1>Review Your Order</h1>
        <div class="payload-options">
          <div>
            <input type="radio" id="payload_option1" name="payload_option" value="option1" checked>
            <label for="payload_option1">Keep using the same payload sent with authorize (order_amount: $190.92)</label>
          </div>

          <div style="margin-top: 20px !important">
            <input type="radio" id="payload_option2" name="payload_option" value="option2">
            <label for="payload_option2">Increase order_amount to $200.00 (e.g. update delivery option)</label>
          </div>

          <div style="margin-top: 20px !important">
            <input type="radio" id="payload_option3" name="payload_option" value="option3">
            <label for="payload_option3">Custom Amount: $</label>
            <input type="number" id="custom-amount" placeholder="Enter amount" style="width: 100px; margin-left: 10px;" min="0" step="0.01">
          </div>

          <div style="margin-top: 20px !important">
            <input type="radio" id="payload_option6" name="payload_option" value="option6">
            <label for="payload_option6">Change purchase_country and purchase_currency (From US-USD to CA-CAD) (Not supported)</label>
          </div>
        </div>
      </div>

      <div class="container mt-5 table-container">
        <table id="authorize-results" class="table table-striped" style="display: none;">
          <thead>
            <tr>
              <th class="text-left wrap-cell">Field</th>
              <th class="text-left wrap-cell">Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left wrap-cell">Authorization Token</td>
              <td class="text-left wrap-cell" id="authorization_token"></td>
              <td><button class="btn-copy">Copy</button></td>
            </tr>
            <tr>
              <td class="text-left wrap-cell">Approved</td>
              <td class="text-left wrap-cell" id="approved"></td>
              <td><button class="btn-copy">Copy</button></td>
            </tr>
            <tr>
              <td class="text-left wrap-cell">Collected Shipping Address</td>
              <td class="text-left wrap-cell" id="collected_shipping_address"></td>
              <td><button class="btn-copy">Copy</button></td>
            </tr>
            <tr>
              <td class="text-left wrap-cell">Finalize Required</td>
              <td class="text-left wrap-cell" id="finalize_required"></td>
              <td><button class="btn-copy">Copy</button></td>
            </tr>
            <tr>
              <td class="text-left wrap-cell">Client Token</td>
              <td class="text-left wrap-cell" id="client_token"></td>
              <td><button class="btn-copy">Copy</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="right-column" style="flex: 1;">
      <h2>Payload Display</h2>
      <div id="order-payload-template-display" style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h3>Order Payload Template</h3>
        <pre id="order-payload-template" style="white-space: pre-wrap; word-wrap: break-word; font-size: 12px;">
{
  "intent": "buy",
  "acquiring_channel": "ecommerce",
  "purchase_country":"{{ _.us_purchase_country }}",
  "purchase_currency":"{{ _.us_purchase_currency }}",
  "locale":"{{ _.locale }}",
  "billing_address": {
    "city": "{{ _.us_billing_city }}",
    "country": "{{ _.us_purchase_country }}",
    "email": "{{ _.us_billing_email }}",
    "phone": "{{ _.us_billing_phone }}",
    "family_name": "{{ _.billing_family_name }}",
    "given_name": "{{ _.billing_given_name }}",
    "postal_code": "{{ _.us_billing_postal_code }}",
    "street_address": "{{ _.us_billing_street_address }}"
  },
  "shipping_address": {
    "city": "{{ _.us_shipping_city }}",
    "country": "{{ _.us_shipping_country }}",
    "email": "{{ _.us_shipping_email }}",
    "phone": "{{ _.us_shipping_phone }}",
    "family_name": "{{ _.shipping_family_name }}",
    "given_name": "{{ _.shipping_given_name }}",
    "postal_code": "{{ _.us_shipping_postal_code }}",
    "street_address": "{{ _.us_shipping_street_address }}"
  },
  "order_amount": 31351,
  "order_tax_amount": 1652,
  "order_lines": [
    {
      "type": "physical",
      "name": "Rikke Nightstand",
      "quantity": 1,
      "unit_price": 30000,
      "total_amount": 30000,
      "product_url": "https://www.macys.com/shop/product/rikke-nightstand?ID=8761899",
      "image_url": "https://slimages.macysassets.com/is/image/MCY/products/8/optimized/12702018_fpx.tif?qlt=85,0&resMode=sharp2&op_usm=1.75,0.3,2,0&wid=1200&fmt=webp"
    },
    {
      "type": "physical",
      "name": "Cariloha Bath Towel",
      "quantity": 1,
      "unit_price": 2199,
      "total_discount_amount": 1000,
      "total_amount": 1199,
      "product_url": "https://www.macys.com/shop/product/cariloha-bath-towel-blue-lagoon-28x54-turkish-cotton-viscose-material-blend-extra-smooth-odor-resistant-highly-absorbent?ID=19226293",
      "image_url": "https://slimages.macysassets.com/is/image/MCY/products/1/optimized/29157611_fpx.tif?qlt=85,0&resMode=sharp2&op_usm=1.75,0.3,2,0&wid=1200&fmt=webp"
    },
    {
      "type": "sales_tax",
      "name": "Sales Tax",
      "quantity": 1,
      "unit_price": 1652,
      "total_amount": 1652
    },
    {
      "type": "gift_card",
      "name": "Gift Card",
      "quantity": 1,
      "unit_price": -500,
      "total_amount": -500
    },
    {
      "type": "discount",
      "name": "Discount",
      "quantity": 1,
      "unit_price": -1000,
      "total_amount": -1000
    },
    {
      "type": "shipping_fee",
      "name": "Free Shipping",
      "quantity": 1,
      "unit_price": 0,
      "total_amount": 0
    }
  ],
  "merchant_urls":{  
    "notification":"{{ _.merchant_url }}",
    "authorization": "{{ _.merchant_url }}"
  },
  "options":{
    "disable_client_side_updates": "true"
  }
}
        </pre>
      </div>
      <div id="authorize-payload-display" style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h3>Authorize Payload</h3>
        <pre id="authorize-payload" style="white-space: pre-wrap; word-wrap: break-word; font-size: 12px;"></pre>
      </div>
      
      <div id="finalize-payload-display" style="background: #f5f5f5; padding: 15px; border-radius: 5px; display: none;">
        <h3>Finalize Payload</h3>
        <pre id="finalize-payload" style="white-space: pre-wrap; word-wrap: break-word; font-size: 12px;"></pre>
      </div>
    </div>


  </div>

  <script>
    // Get the modal
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var btn = document.getElementById("feedback-button");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal
    btn.onclick = function () {
      modal.style.display = "block";
    };

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
      modal.style.display = "none";
    };

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };

    let copyButtons = document.querySelectorAll(".btn-copy");

    copyButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        let valueCell = this.parentNode.previousElementSibling;
        let range = document.createRange();
        range.selectNode(valueCell);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        window.getSelection().removeAllRanges();

        let initialText = this.innerText;

        this.innerText = "Copied";

        setTimeout(() => {
          this.innerText = initialText;
        }, 5000);
      });
    });

    // Handle custom amount input
    var customAmountInput = document.getElementById('custom-amount');
    var customAmountRadio = document.getElementById('payload_option3');
    
    // Enable/disable custom amount input based on radio selection
    document.querySelectorAll('input[name="payload_option"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (this.value === 'option3') {
          customAmountInput.disabled = false;
          customAmountInput.focus();
        } else {
          customAmountInput.disabled = true;
        }
      });
    });
    
    // Initially disable custom amount input
    customAmountInput.disabled = true;
  </script>
</body>

</html>
